name: Build Custom Geodata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "domains_download_url=https://github.com/DustinWin/domain-list-custom/releases/download/domains" >> ${GITHUB_ENV}
          echo "ips_download_url=https://github.com/DustinWin/geoip/releases/download/ips" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 任务一：构建 Geosite (域名数据库)
      # ------------------------------------------------------------------------
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate Custom `geosite.dat`
        run: |
          mkdir -p ./community/mydata/
          archs=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn media games ai networktest tld-proxy gfw proxy cn tiktok youtube)

          for arch in "${archs[@]}"; do
            echo "Downloading ${arch}..."
            curl -sSL "${domains_download_url}/${arch}.list" | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' -e 's/DOMAIN-KEYWORD,/keyword:/' -e 's/DOMAIN-REGEX,/regexp:/' > "./community/mydata/${arch}"
          done

          echo "Processing fakeip-filter..."
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '!/^DOMAIN-REGEX,/' | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./community/mydata/fakeip-filter
          cat <<EOF >> ./community/mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' | sed 's/DOMAIN-REGEX,/regexp:/' >> ./community/mydata/fakeip-filter

          echo "Generating custom 'download' rule..."
          curl -sSL "https://ruleset.skk.moe/Clash/domainset/download.txt" | sed 's/+\.//g' > ./temp_download_1
          curl -sSL "https://mihomo.deng2z.xyz/config/download.txt" | sed 's/+\.//g' > ./temp_download_2
          cat ./temp_download_1 ./temp_download_2 > ./community/mydata/download
          rm ./temp_download_1 ./temp_download_2
          
          echo "Appending custom direct list to 'cn' rule..."
          curl -sSL "https://mihomo.deng2z.xyz/config/direct.txt" | sed 's/+\.//g' >> ./community/mydata/cn

          cd ./community/
          go run ./ --datapath=./mydata/ --outputname geosite.dat
          cd ..

      # ------------------------------------------------------------------------
      # 任务二：构建 GeoIP (IP数据库)
      # ------------------------------------------------------------------------
      - name: Checkout v2fly/geoip
        uses: actions/checkout@v4
        with:
          repository: v2fly/geoip
          path: geoip-src

      - name: Generate Custom `geoip.dat`
        run: |
          # 1. 准备目录
          mkdir -p ./geoip-src/data
          mkdir -p ./geoip-src/maxmind_data
          
          # 2. 下载基础文本规则 (来源: DustinWin)
          echo "Downloading base IP lists..."
          wget -O ./geoip-src/data/cn "${ips_download_url}/cnip.list"
          wget -O ./geoip-src/data/private "${ips_download_url}/privateip.list"
          wget -O ./geoip-src/data/media "${ips_download_url}/mediaip.list"
          wget -O ./geoip-src/data/games "${ips_download_url}/gamesip.list"
          wget -O ./geoip-src/data/telegram "${ips_download_url}/telegramip.list"

          # 3. 下载并解压 ASN CSV 文件 (用于 Bytedance)
          echo "Downloading and preparing MaxMind CSV data..."
          wget -O temp_asn.zip "https://github.com/Loyalsoldier/geoip/raw/refs/heads/release/GeoLite2-ASN-CSV.zip"
          unzip -q temp_asn.zip -d temp_unzip
          
          # 动态查找解压后的文件夹名称
          BD_DIR=$(find temp_unzip -maxdepth 1 -type d -name "GeoLite2-ASN-CSV_*")
          
          # 将 CSV 文件移动到固定位置，方便 config.json 引用
          mv "$BD_DIR/GeoLite2-ASN-Blocks-IPv4.csv" ./geoip-src/maxmind_data/ipv4.csv
          mv "$BD_DIR/GeoLite2-ASN-Blocks-IPv6.csv" ./geoip-src/maxmind_data/ipv6.csv
          
          # 清理临时文件
          rm -rf temp_asn.zip temp_unzip

          # 4. 生成 config.json 配置文件
          # 注意：这里使用了 maxmindGeoLite2ASNCSV 类型直接读取 CSV
          echo "Generating config.json..."
          cat <<EOF > ./geoip-src/config.json
          {
            "input": [
              { "type": "text", "action": "add", "args": { "name": "cn", "uri": "data/cn" } },
              { "type": "text", "action": "add", "args": { "name": "private", "uri": "data/private" } },
              { "type": "text", "action": "add", "args": { "name": "media", "uri": "data/media" } },
              { "type": "text", "action": "add", "args": { "name": "games", "uri": "data/games" } },
              { "type": "text", "action": "add", "args": { "name": "telegram", "uri": "data/telegram" } },
              {
                "type": "maxmindGeoLite2ASNCSV",
                "action": "add",
                "args": {
                  "ipv4": "maxmind_data/ipv4.csv",
                  "ipv6": "maxmind_data/ipv6.csv",
                  "wantedList": {
                    "bytedance": ["396986"]
                  }
                }
              }
            ],
            "output": [
              {
                "type": "v2rayGeoIPDat",
                "action": "output",
                "args": {
                  "outputName": "geoip.dat",
                  "outputDir": "."
                }
              }
            ]
          }
          EOF

          # 5. 编译 geoip
          cd ./geoip-src
          echo "Compiling geoip.dat with config..."
          go run ./ -c config.json
          cd ..

      # ------------------------------------------------------------------------
      # 任务三：发布与推送
      # ------------------------------------------------------------------------
      - name: Prepare Assets
        run: |
          mkdir -p ./publish/
          mv ./community/geosite.dat ./publish/
          mv ./geoip-src/geoip.dat ./publish/

      - name: Release and Upload Assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: custom-geodata
          tag: custom-geodata
          overwrite: true
          body: |
            自定义 Geodata 文件
            包含规则: geosite.dat, geoip.dat
            更新时间: ${{ env.update_version }}
            
            [Geosite]
            新增: tiktok, youtube, download
            修改: cn (追加 custom direct)
            
            [GeoIP]
            包含: cn, private, media, games, telegram
            新增: bytedance (ASN: 396986, using maxmindGeoLite2ASNCSV)
          file_glob: true
          file: ./publish/*

      - name: Commit and Push to Branch
        run: |
          cd ./publish/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b publish
          git add .
          git commit -m "Geodata updated on ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin publish
