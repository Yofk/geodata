name: Build Custom Geodata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "domains_download_url=https://github.com/DustinWin/domain-list-custom/releases/download/domains" >> ${GITHUB_ENV}
          echo "ips_download_url=https://github.com/DustinWin/geoip/releases/download/ips" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 任务一：构建 Geosite (域名数据库)
      # ------------------------------------------------------------------------
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate Custom `geosite.dat`
        run: |
          # 1. 创建数据目录
          mkdir -p ./community/mydata/
          
          # 2. 定义基础规则列表 (新增 tiktok, youtube)
          archs=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn media games ai networktest tld-proxy gfw proxy cn tiktok youtube)

          # 3. 下载上游规则并转换格式
          for arch in "${archs[@]}"; do
            echo "Downloading ${arch}..."
            curl -sSL "${domains_download_url}/${arch}.list" | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' -e 's/DOMAIN-KEYWORD,/keyword:/' -e 's/DOMAIN-REGEX,/regexp:/' > "./community/mydata/${arch}"
          done

          # 4. 处理 fakeip-filter
          echo "Processing fakeip-filter..."
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '!/^DOMAIN-REGEX,/' | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./community/mydata/fakeip-filter
          cat <<EOF >> ./community/mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' | sed 's/DOMAIN-REGEX,/regexp:/' >> ./community/mydata/fakeip-filter

          # 5. 生成 'download' 规则 (合并 skk.moe 和 deng2z.xyz)
          echo "Generating custom 'download' rule..."
          curl -sSL "https://ruleset.skk.moe/Clash/domainset/download.txt" | sed 's/+\.//g' > ./temp_download_1
          curl -sSL "https://mihomo.deng2z.xyz/config/download.txt" | sed 's/+\.//g' > ./temp_download_2
          cat ./temp_download_1 ./temp_download_2 > ./community/mydata/download
          rm ./temp_download_1 ./temp_download_2
          
          # 6. 修改 'cn' 规则 (追加 custom direct)
          echo "Appending custom direct list to 'cn' rule..."
          curl -sSL "https://mihomo.deng2z.xyz/config/direct.txt" | sed 's/+\.//g' >> ./community/mydata/cn

          # 7. 编译 geosite (注意 outputname 已改为 geosite.dat)
          cd ./community/
          go run ./ --datapath=./mydata/ --outputname geosite.dat
          cd ..

      # ------------------------------------------------------------------------
      # 任务二：构建 GeoIP (IP数据库)
      # ------------------------------------------------------------------------
      - name: Checkout v2fly/geoip
        uses: actions/checkout@v4
        with:
          repository: v2fly/geoip
          path: geoip-src

      - name: Generate Custom `geoip.dat`
        run: |
          # 准备数据目录
          mkdir -p ./geoip-src/data
          rm -f ./geoip-src/data/*

          # 1. 下载基础规则 (来源: DustinWin, 保持与原版一致)
          # 注意：DustinWin 的文件名是 xxip.list，我们需要重命名为不带 ip 的标签名以便使用 (如 geoip:private)
          echo "Downloading base IP lists..."
          wget -O ./geoip-src/data/cn "${ips_download_url}/cnip.list"
          wget -O ./geoip-src/data/private "${ips_download_url}/privateip.list"
          wget -O ./geoip-src/data/media "${ips_download_url}/mediaip.list"
          wget -O ./geoip-src/data/games "${ips_download_url}/gamesip.list"
          wget -O ./geoip-src/data/telegram "${ips_download_url}/telegramip.list"

          # 2. 生成 'bytedance' 规则 (来源: Loyalsoldier ASN CSV)
          echo "Generating 'bytedance' rule from ASN 396986..."
          mkdir -p ./temp_bd
          cd ./temp_bd
          
          # 下载并解压
          wget "https://github.com/Loyalsoldier/geoip/raw/refs/heads/release/GeoLite2-ASN-CSV.zip"
          unzip -q GeoLite2-ASN-CSV.zip
          
          # 找到解压后的文件夹 (因为日期是动态的)
          BD_DIR=$(find . -type d -name "GeoLite2-ASN-CSV_*")
          
          # 提取 IPv4 和 IPv6 (ASN 396986)
          # 使用 awk 精确匹配第二列 ASN 号，并打印第一列 CIDR
          awk -F, '$2 == "396986" {print $1}' "$BD_DIR/GeoLite2-ASN-Blocks-IPv4.csv" > ../bytedance.txt
          awk -F, '$2 == "396986" {print $1}' "$BD_DIR/GeoLite2-ASN-Blocks-IPv6.csv" >> ../bytedance.txt
          
          cd ..
          rm -rf ./temp_bd
          
          # 移动到 data 目录
          mv bytedance.txt ../geoip-src/data/bytedance
          
          # 3. 编译 geoip
          cd ../geoip-src
          echo "Compiling geoip.dat..."
          go run ./ --datapath=./data/ --outputname=geoip.dat
          cd ..

      # ------------------------------------------------------------------------
      # 任务三：发布与推送
      # ------------------------------------------------------------------------
      - name: Prepare Assets
        run: |
          mkdir -p ./publish/
          mv ./community/geosite.dat ./publish/
          mv ./geoip-src/geoip.dat ./publish/

      - name: Release and Upload Assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: custom-geodata
          tag: custom-geodata
          overwrite: true
          body: |
            自定义 Geodata 文件
            包含规则: geosite.dat, geoip.dat
            更新时间: ${{ env.update_version }}
            
            [Geosite]
            新增: tiktok, youtube, download
            修改: cn (追加 custom direct)
            
            [GeoIP]
            包含: cn, private, media, games, telegram
            新增: bytedance (ASN: 396986)
          file_glob: true
          file: ./publish/*

      - name: Commit and Push to Branch
        run: |
          cd ./publish/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b publish
          git add .
          git commit -m "Geodata updated on ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin publish
