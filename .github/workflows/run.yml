name: Build Custom Geodata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "domains_download_url=https://github.com/DustinWin/domain-list-custom/releases/download/domains" >> ${GITHUB_ENV}
          echo "ips_download_url=https://github.com/DustinWin/geoip/releases/download/ips" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Repository
        uses: actions/checkout@v4

      # 检出编译工具所需的 community 仓库
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate Custom `geosite.dat`
        run: |
          # 1. 创建数据目录
          mkdir -p ./community/mydata/
          
          # 2. 定义基础规则列表 (基于原项目 geosite-all.dat 的包含规则)
          # 在此添加了 'tiktok' 和 'youtube'
          archs=(private microsoft-cn apple-cn google-cn games-cn media games ai proxy cn tiktok youtube)

          # 3. 下载上游 DustinWin 的规则
          # 逻辑：将 DOMAIN 转换为 full:，去除 DOMAIN-SUFFIX (默认为后缀匹配)
          for arch in "${archs[@]}"; do
            echo "Downloading ${arch}..."
            curl -sSL "${domains_download_url}/${arch}.list" | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' -e 's/DOMAIN-KEYWORD,/keyword:/' -e 's/DOMAIN-REGEX,/regexp:/' > "./community/mydata/${arch}"
          done

          # 4. 处理 fakeip-filter (保留原项目逻辑，合并到 geosite-all 中)
          echo "Processing fakeip-filter..."
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '!/^DOMAIN-REGEX,/' | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./community/mydata/fakeip-filter
          cat <<EOF >> ./community/mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' | sed 's/DOMAIN-REGEX,/regexp:/' >> ./community/mydata/fakeip-filter

          # ----------------------------------------------------------------------
          # 5. [新增] 创建 'download' 规则
          # 来源：skk.moe 和 deng2z.xyz
          # 处理逻辑：sed 's/+\.//g' 用于去除行首的 "+."，使其变成标准域名后缀格式
          echo "Generating custom 'download' rule..."
          curl -sSL "https://ruleset.skk.moe/Clash/domainset/download.txt" | sed 's/+\.//g' > ./temp_download_1
          curl -sSL "https://mihomo.deng2z.xyz/config/download.txt" | sed 's/+\.//g' > ./temp_download_2
          cat ./temp_download_1 ./temp_download_2 > ./community/mydata/download
          rm ./temp_download_1 ./temp_download_2
          
          # ----------------------------------------------------------------------
          # 6. [修改] 将自定义 direct.txt 追加到 'cn' 规则中
          # 来源：deng2z.xyz
          echo "Appending custom direct list to 'cn' rule..."
          curl -sSL "https://mihomo.deng2z.xyz/config/direct.txt" | sed 's/+\.//g' >> ./community/mydata/cn

          # ----------------------------------------------------------------------
          # 7. 开始编译 geosite.dat
          cd ./community/
          # 编译 ./mydata 目录下的所有文件
          go run ./ --datapath=./mydata/ --outputname geosite.dat
          cd ..

      - name: Get `geoip.dat`
        run: |
          mkdir -p ./publish/
          # 直接下载 DustinWin 已经生成好的 geoip.dat (包含了 private, cn, media, games, telegram)
          # 如果你需要更全的 IP 库，可以将 geoip.dat 换成 geoip-all.dat
          echo "Downloading geoip.dat..."
          wget -O ./publish/geoip.dat "https://github.com/DustinWin/ruleset_geodata/releases/download/mihomo-geodata/geoip.dat"

      - name: Move Generated Geosite
        run: |
          # 将生成的 geosite 移动到发布目录
          mv ./community/geosite.dat ./publish/

      - name: Release and Upload Assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: custom-geodata
          tag: custom-geodata
          overwrite: true
          body: |
            自定义 Geodata 文件
            包含规则: geosite.dat, geoip.dat
            更新时间: ${{ env.update_version }}
            
            新增规则: tiktok, youtube, download
            修改规则: cn (追加了 custom direct)
          file_glob: true
          file: ./publish/*

      - name: Commit and Push to Branch
        run: |
          cd ./publish/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b publish
          git add .
          git commit -m "Geodata updated on ${update_version}"
          # 强制推送到 publish 分支，这样你可以直接在分支里看到最终文件
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin publish
