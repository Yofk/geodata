name: Build Custom Geodata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "domains_download_url=https://github.com/DustinWin/domain-list-custom/releases/download/domains" >> ${GITHUB_ENV}
          echo "ips_download_url=https://github.com/DustinWin/geoip/releases/download/ips" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 任务一：构建 Geosite (域名数据库)
      # ------------------------------------------------------------------------
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate Custom `geosite.dat`
        run: |
          mkdir -p ./community/mydata/
          archs=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn media games ai networktest tld-proxy gfw proxy cn tiktok youtube)

          for arch in "${archs[@]}"; do
            echo "Downloading ${arch}..."
            curl -sSL "${domains_download_url}/${arch}.list" | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' -e 's/DOMAIN-KEYWORD,/keyword:/' -e 's/DOMAIN-REGEX,/regexp:/' > "./community/mydata/${arch}"
          done

          echo "Processing fakeip-filter..."
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '!/^DOMAIN-REGEX,/' | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./community/mydata/fakeip-filter
          cat <<EOF >> ./community/mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' | sed 's/DOMAIN-REGEX,/regexp:/' >> ./community/mydata/fakeip-filter

          echo "Generating custom 'download' rule..."
          curl -sSL "https://ruleset.skk.moe/Clash/domainset/download.txt" | sed 's/+\.//g' > ./temp_download_1
          curl -sSL "https://mihomo.deng2z.xyz/config/download.txt" | sed 's/+\.//g' > ./temp_download_2
          cat ./temp_download_1 ./temp_download_2 > ./community/mydata/download
          rm ./temp_download_1 ./temp_download_2
          
          echo "Appending custom direct list to 'cn' rule..."
          curl -sSL "https://mihomo.deng2z.xyz/config/direct.txt" | sed 's/+\.//g' >> ./community/mydata/cn

          cd ./community/
          go run ./ --datapath=./mydata/ --outputname geosite.dat
          cd ..

      # ------------------------------------------------------------------------
      # 任务二：构建 GeoIP (IP数据库)
      # ------------------------------------------------------------------------
      # [关键修改] 使用 Loyalsoldier/geoip 仓库，它支持 config.json 和 CSV 读取功能
      - name: Checkout Loyalsoldier/geoip
        uses: actions/checkout@v4
        with:
          repository: Loyalsoldier/geoip
          path: geoip-src

      - name: Generate Custom `geoip.dat`
        run: |
          # 1. 准备目录结构
          # Loyalsoldier 的 config.json 中可以使用相对路径引用这些文件
          mkdir -p ./geoip-src/data
          mkdir -p ./geoip-src/geolite2

          # 2. 下载基础规则 (来源: DustinWin)
          # 注意：Loyalsoldier 支持本地文件路径，只要uri写对即可
          echo "Downloading base IP lists..."
          wget -O ./geoip-src/data/cn.txt "${ips_download_url}/cnip.list"
          wget -O ./geoip-src/data/private.txt "${ips_download_url}/privateip.list"
          wget -O ./geoip-src/data/media.txt "${ips_download_url}/mediaip.list"
          wget -O ./geoip-src/data/games.txt "${ips_download_url}/gamesip.list"
          wget -O ./geoip-src/data/telegram.txt "${ips_download_url}/telegramip.list"

          # 3. 下载并准备 MaxMind ASN CSV 数据 (用于 Bytedance)
          echo "Downloading MaxMind ASN CSV..."
          wget -O ./temp_asn.zip "https://github.com/Loyalsoldier/geoip/raw/refs/heads/release/GeoLite2-ASN-CSV.zip"
          unzip -q ./temp_asn.zip -d ./temp_unzip
          
          # 找到解压后的文件夹
          BD_DIR=$(find ./temp_unzip -maxdepth 1 -type d -name "GeoLite2-ASN-CSV_*")
          
          # 将 CSV 移动到 config.json 预期的位置
          mv "$BD_DIR/GeoLite2-ASN-Blocks-IPv4.csv" ./geoip-src/geolite2/ipv4.csv
          mv "$BD_DIR/GeoLite2-ASN-Blocks-IPv6.csv" ./geoip-src/geolite2/ipv6.csv
          
          # 清理临时文件
          rm -rf ./temp_asn.zip ./temp_unzip

          # 4. 生成 Loyalsoldier 格式的 config.json
          # 重点：使用了 maxmindGeoLite2ASNCSV 类型，并指向了步骤3中准备好的文件
          echo "Generating config.json..."
          cat <<EOF > ./geoip-src/config.json
          {
            "input": [
              {
                "type": "text",
                "action": "add",
                "args": {
                  "name": "cn",
                  "uri": "data/cn.txt"
                }
              },
              {
                "type": "text",
                "action": "add",
                "args": {
                  "name": "private",
                  "uri": "data/private.txt"
                }
              },
              {
                "type": "text",
                "action": "add",
                "args": {
                  "name": "media",
                  "uri": "data/media.txt"
                }
              },
              {
                "type": "text",
                "action": "add",
                "args": {
                  "name": "games",
                  "uri": "data/games.txt"
                }
              },
              {
                "type": "text",
                "action": "add",
                "args": {
                  "name": "telegram",
                  "uri": "data/telegram.txt"
                }
              },
              {
                "type": "maxmindGeoLite2ASNCSV",
                "action": "add",
                "args": {
                  "ipv4": "./geolite2/ipv4.csv",
                  "ipv6": "./geolite2/ipv6.csv",
                  "wantedList": {
                    "bytedance": ["396986"]
                  }
                }
              }
            ],
            "output": [
              {
                "type": "v2rayGeoIPDat",
                "action": "output",
                "args": {
                  "outputName": "geoip.dat",
                  "outputDir": "."
                }
              }
            ]
          }
          EOF

          # 5. 编译 geoip.dat
          cd ./geoip-src
          echo "Compiling geoip.dat..."
          # Loyalsoldier/geoip 使用 -c 参数加载配置文件
          go run ./ -c config.json
          cd ..

      # ------------------------------------------------------------------------
      # 任务三：发布与推送
      # ------------------------------------------------------------------------
      - name: Prepare Assets
        run: |
          mkdir -p ./publish/
          mv ./community/geosite.dat ./publish/
          mv ./geoip-src/geoip.dat ./publish/

      - name: Release and Upload Assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: custom-geodata
          tag: custom-geodata
          overwrite: true
          body: |
            自定义 Geodata 文件
            包含规则: geosite.dat, geoip.dat
            更新时间: ${{ env.update_version }}
            
            [Geosite]
            新增: tiktok, youtube, download
            修改: cn (追加 custom direct)
            
            [GeoIP]
            构建引擎: Loyalsoldier/geoip
            包含: cn, private, media, games, telegram
            新增: bytedance (ASN: 396986, using maxmindGeoLite2ASNCSV)
          file_glob: true
          file: ./publish/*

      - name: Commit and Push to Branch
        run: |
          cd ./publish/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b publish
          git add .
          git commit -m "Geodata updated on ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin publish
