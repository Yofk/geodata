name: Build Custom Geodata
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          echo "domains_download_url=https://github.com/DustinWin/domain-list-custom/releases/download/domains" >> ${GITHUB_ENV}
        shell: bash

      - name: Checkout Repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 任务一：构建 Geosite (域名数据库) - 保持不变
      # ------------------------------------------------------------------------
      - name: Checkout v2fly/domain-list-community
        uses: actions/checkout@v4
        with:
          repository: v2fly/domain-list-community
          path: community

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate Custom `geosite.dat`
        run: |
          mkdir -p ./community/mydata/
          archs=(private ads trackerslist microsoft-cn apple-cn google-cn games-cn media games ai networktest tld-proxy gfw proxy cn tiktok youtube)

          for arch in "${archs[@]}"; do
            echo "Downloading ${arch}..."
            curl -sSL "${domains_download_url}/${arch}.list" | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' -e 's/DOMAIN-KEYWORD,/keyword:/' -e 's/DOMAIN-REGEX,/regexp:/' > "./community/mydata/${arch}"
          done

          echo "Processing fakeip-filter..."
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '!/^DOMAIN-REGEX,/' | sed -e 's/DOMAIN,/full:/' -e 's/DOMAIN-SUFFIX,//' > ./community/mydata/fakeip-filter
          cat <<EOF >> ./community/mydata/fakeip-filter
          keyword:ntp
          keyword:stun
          keyword:time
          EOF
          curl -sSL "${domains_download_url}/fakeip-filter.list" | awk '/^DOMAIN-REGEX,/ && !/ntp|stun|time/' | sed 's/DOMAIN-REGEX,/regexp:/' >> ./community/mydata/fakeip-filter

          echo "Generating custom 'download' rule..."
          curl -sSL "https://ruleset.skk.moe/Clash/domainset/download.txt" | sed 's/+\.//g' > ./temp_download_1
          curl -sSL "https://mihomo.deng2z.xyz/config/download.txt" | sed 's/+\.//g' > ./temp_download_2
          cat ./temp_download_1 ./temp_download_2 > ./community/mydata/download
          rm ./temp_download_1 ./temp_download_2
          
          echo "Appending custom direct list to 'cn' rule..."
          curl -sSL "https://mihomo.deng2z.xyz/config/direct.txt" | sed 's/+\.//g' >> ./community/mydata/cn

          cd ./community/
          go run ./ --datapath=./mydata/ --outputname geosite.dat
          cd ..

      # ------------------------------------------------------------------------
      # 任务二：构建 GeoIP (IP数据库)
      # ------------------------------------------------------------------------
      - name: Checkout Loyalsoldier/geoip
        uses: actions/checkout@v4
        with:
          repository: Loyalsoldier/geoip
          path: geoip-src

      - name: Prepare GeoIP Config & Data
        run: |
          # 1. 准备目录结构
          mkdir -p ./geoip-src/geolite2
          
          # 2. 下载并解压 ASN CSV (用于提取 Bytedance 和 Valve)
          echo "Downloading MaxMind ASN CSV..."
          wget -O temp_asn.zip "https://github.com/Loyalsoldier/geoip/raw/refs/heads/release/GeoLite2-ASN-CSV.zip"
          unzip -q temp_asn.zip -d temp_unzip
          
          # 3. 移动 CSV 文件
          BD_DIR=$(find temp_unzip -maxdepth 1 -type d -name "GeoLite2-ASN-CSV_*")
          mv "$BD_DIR/GeoLite2-ASN-Blocks-IPv4.csv" ./geoip-src/geolite2/
          mv "$BD_DIR/GeoLite2-ASN-Blocks-IPv6.csv" ./geoip-src/geolite2/
          rm -rf temp_asn.zip temp_unzip

          # 4. 生成 config.json
          # [修改点]: 在 wantedList 中添加了 "valve": ["32590"]
          echo "Generating config.json..."
          cat <<EOF > ./geoip-src/config.json
          {
            "input": [
              {
                "type": "v2rayGeoIPDat",
                "action": "add",
                "args": {
                  "uri": "https://github.com/DustinWin/geoip/releases/download/mihomo-geodata/geoip.dat",
                  "wantedList": ["cn", "private", "media", "games", "telegram"]
                }
              },
              {
                "type": "maxmindGeoLite2ASNCSV",
                "action": "add",
                "args": {
                  "ipv4": "./geolite2/GeoLite2-ASN-Blocks-IPv4.csv",
                  "ipv6": "./geolite2/GeoLite2-ASN-Blocks-IPv6.csv",
                  "wantedList": {
                    "bytedance": ["396986"],
                    "valve": ["32590"]
                  }
                }
              }
            ],
            "output": [
              {
                "type": "v2rayGeoIPDat",
                "action": "output",
                "args": {
                  "outputName": "geoip.dat",
                  "outputDir": "."
                }
              }
            ]
          }
          EOF

      - name: Compile Custom `geoip.dat`
        run: |
          cd ./geoip-src
          # 5. 编译运行
          echo "Compiling geoip.dat..."
          go run ./ convert -c config.json
          cd ..

      # ------------------------------------------------------------------------
      # 任务三：发布与推送
      # ------------------------------------------------------------------------
      - name: Prepare Assets
        run: |
          mkdir -p ./publish/
          mv ./community/geosite.dat ./publish/
          mv ./geoip-src/geoip.dat ./publish/

      - name: Release and Upload Assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: custom-geodata
          tag: custom-geodata
          overwrite: true
          body: |
            自定义 Geodata 文件
            包含规则: geosite.dat, geoip.dat
            更新时间: ${{ env.update_version }}
            
            [Geosite]
            新增: tiktok, youtube, download
            修改: cn (追加 custom direct)
            
            [GeoIP]
            基础规则源: DustinWin/geoip (mihomo-geodata)
            包含 Tag: cn, private, media, games, telegram
            新增 Tag: bytedance (ASN: 396986), valve (ASN: 32590)
          file_glob: true
          file: ./publish/*

      - name: Commit and Push to Branch
        run: |
          cd ./publish/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b publish
          git add .
          git commit -m "Geodata updated on ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin publish
